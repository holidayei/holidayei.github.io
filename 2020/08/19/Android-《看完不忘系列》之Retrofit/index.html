<!DOCTYPE html>



  


<html class="theme-next pisces use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Android," />










<meta name="description" content="嗨，我是哈利迪~《看完不忘系列》将以从树干到细枝的思路分析一些技术框架，本文将对开源项目Retrofit进行介绍。  本文约2800字，阅读大约8分钟。 Retrofit源码基于最新版本2.9.0  预备Retrofit使得网络调用可以像RESTful设计风格一样简洁，如： 12345interface WanApi &amp;#123;    &#x2F;&#x2F;用注解标记网络请求方式get、post，参数path、q">
<meta property="og:type" content="article">
<meta property="og:title" content="Android |《看完不忘系列》之Retrofit">
<meta property="og:url" content="https://github.com/holidayei/2020/08/19/Android-%E3%80%8A%E7%9C%8B%E5%AE%8C%E4%B8%8D%E5%BF%98%E7%B3%BB%E5%88%97%E3%80%8B%E4%B9%8BRetrofit/index.html">
<meta property="og:site_name" content="Holiday">
<meta property="og:description" content="嗨，我是哈利迪~《看完不忘系列》将以从树干到细枝的思路分析一些技术框架，本文将对开源项目Retrofit进行介绍。  本文约2800字，阅读大约8分钟。 Retrofit源码基于最新版本2.9.0  预备Retrofit使得网络调用可以像RESTful设计风格一样简洁，如： 12345interface WanApi &amp;#123;    &#x2F;&#x2F;用注解标记网络请求方式get、post，参数path、q">
<meta property="og:image" content="https://tva1.sinaimg.cn/large/007S8ZIlly1ghsrydohxsj30wu05ujs4.jpg">
<meta property="og:image" content="https://tva1.sinaimg.cn/large/007S8ZIlly1ghsugw5whvj30x40f4jtg.jpg">
<meta property="og:image" content="https://tva1.sinaimg.cn/large/007S8ZIlly1ghvcvkfh1oj31740lodko.jpg">
<meta property="og:image" content="https://tva1.sinaimg.cn/large/007S8ZIlly1gg3mnwsbshj308c0augmm.jpg">
<meta property="article:published_time" content="2020-08-19T01:11:37.000Z">
<meta property="article:modified_time" content="2020-08-19T02:00:41.986Z">
<meta property="article:author" content="哈利迪">
<meta property="article:tag" content="Android">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://tva1.sinaimg.cn/large/007S8ZIlly1ghsrydohxsj30wu05ujs4.jpg">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="https://github.com/holidayei/2020/08/19/Android-《看完不忘系列》之Retrofit/"/>





  <title>Android |《看完不忘系列》之Retrofit | Holiday</title>
  








<meta name="generator" content="Hexo 4.2.0"></head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Holiday</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://github.com/holidayei/2020/08/19/Android-%E3%80%8A%E7%9C%8B%E5%AE%8C%E4%B8%8D%E5%BF%98%E7%B3%BB%E5%88%97%E3%80%8B%E4%B9%8BRetrofit/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="哈利迪">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Holiday">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">Android |《看完不忘系列》之Retrofit</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2020-08-19T09:11:37+08:00">
                2020-08-19
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <p>嗨，我是哈利迪~《看完不忘系列》将以<code>从树干到细枝</code>的思路分析一些技术框架，本文将对开源项目<code>Retrofit</code>进行介绍。</p>
<blockquote>
<p>本文约2800字，阅读大约8分钟。</p>
<p>Retrofit源码基于最新版本2.9.0</p>
</blockquote>
<h2 id="预备"><a href="#预备" class="headerlink" title="预备"></a>预备</h2><p>Retrofit使得网络调用可以像<a href="https://baike.baidu.com/item/RESTful/4406165" target="_blank" rel="noopener">RESTful设计风格</a>一样简洁，如：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">WanApi</span> </span>&#123;</span><br><span class="line">    <span class="comment">//用注解标记网络请求方式get、post，参数path、query等</span></span><br><span class="line">    <span class="meta">@GET</span>(<span class="string">"article/list/&#123;page&#125;/json"</span>)</span><br><span class="line">    <span class="function">Call&lt;WanArticleBean&gt; <span class="title">articleList</span><span class="params">(@Path(<span class="string">"page"</span>)</span> <span class="keyword">int</span> page)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>又如，后端的Spring Boot框架通过<code>约定大于配置</code>思想省去了很多配置，其在网络接口<a href="https://github.com/holidayei/TangramService/blob/master/src/main/java/com/ch/tangram/controller/ActivityController.java#L18">RestController</a>上也运用了这种风格，</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ActivityController</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> ActivityService activityService;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//用注解标记网络请求方式和入参</span></span><br><span class="line">    <span class="meta">@GetMapping</span>(<span class="string">"/goods"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> ResultEntity <span class="title">queryGoods</span><span class="params">(@RequestParam(<span class="string">"page"</span>)</span> <span class="keyword">int</span> page) </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> activityService.queryGoods(page);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Retrofit的底层网络实现基于okhttp，自身的类不是很多，最核心的点就是<code>动态代理</code>了。<code>代理模式</code>简单来说，就是为对象提供一个<code>增强</code>或<code>控制其访问</code>的代理。下面我们先来了解下<code>静态代理</code>和<code>动态代理</code>~</p>
<h3 id="静态代理"><a href="#静态代理" class="headerlink" title="静态代理"></a>静态代理</h3><p>编译期就完成代理</p>
<ul>
<li>源码级：手动编写代理类、APT生成代理类</li>
<li>字节码级：编译期生成字节码、</li>
</ul>
<p>举个栗子，</p>
<p><img src="https://tva1.sinaimg.cn/large/007S8ZIlly1ghsrydohxsj30wu05ujs4.jpg" alt=""></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">interface</span> 赚钱 </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">makeMoney</span><span class="params">(<span class="keyword">int</span> income)</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> 小鲜肉 <span class="keyword">implements</span> 赚钱 </span>&#123; <span class="comment">//委托类</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">makeMoney</span><span class="params">(<span class="keyword">int</span> income)</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"开拍，赚个"</span> + income);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> 经纪人 <span class="keyword">implements</span> 赚钱 </span>&#123; <span class="comment">//代理类</span></span><br><span class="line">    赚钱 xxr;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> 经纪人(赚钱 xxr) &#123;</span><br><span class="line">        <span class="keyword">this</span>.xxr = xxr;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">makeMoney</span><span class="params">(<span class="keyword">int</span> income)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (income &lt; <span class="number">1000_0000</span>) &#123; <span class="comment">//控制访问</span></span><br><span class="line">            System.out.println(<span class="string">"才"</span> + income + <span class="string">"，先回去等通知吧"</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            xxr.makeMoney(income);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">    赚钱 xxr = <span class="keyword">new</span> 小鲜肉();</span><br><span class="line">    赚钱 jjr = <span class="keyword">new</span> 经纪人(xxr);</span><br><span class="line">    jjr.makeMoney(<span class="number">100_0000</span>); <span class="comment">//输出：才1000000，先回去等通知吧</span></span><br><span class="line">    jjr.makeMoney(<span class="number">1000_0000</span>); <span class="comment">//输出：开拍，赚个10000000</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>为什么<code>代理类</code>和<code>委托类</code>要实现相同接口？是为了尽可能保证<code>代理类</code>的内部结构和<code>委托类</code>一致，这样对<code>代理类</code>的操作都可以转移到<code>委托类</code>上，<code>代理类</code>只关注<code>增强</code>和<code>控制</code>。</p>
<h3 id="动态代理"><a href="#动态代理" class="headerlink" title="动态代理"></a>动态代理</h3><p>运行期生成字节码，如Proxy.newProxyInstance、<a href="https://github.com/cglib/cglib">CGLIB</a></p>
<blockquote>
<p>Proxy.newProxyInstance是java自带，只能对接口代理（因为生成的类已经继承了Proxy，java没法多继承）</p>
<p>CGLIB则更强大，还能对普通类代理，底层基于ASM（ASM使用类似<a href="https://baike.baidu.com/item/SAX解析/10406120" target="_blank" rel="noopener">SAX解析器</a>逐行扫描来提高性能）</p>
</blockquote>
<p>举个栗子，</p>
<p><img src="https://tva1.sinaimg.cn/large/007S8ZIlly1ghsugw5whvj30x40f4jtg.jpg" alt=""></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> 合作标准 <span class="keyword">implements</span> <span class="title">InvocationHandler</span> </span>&#123;</span><br><span class="line">    赚钱 xxr;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> 合作标准(赚钱 xxr) &#123;</span><br><span class="line">        <span class="keyword">this</span>.xxr = xxr;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">invoke</span><span class="params">(Object proxy, Method method, Object[] args)</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> income = (<span class="keyword">int</span>) args[<span class="number">0</span>];</span><br><span class="line">        <span class="keyword">if</span> (income &lt; <span class="number">1000_0000</span>) &#123; <span class="comment">//控制访问</span></span><br><span class="line">            System.out.println(<span class="string">"才"</span> + income + <span class="string">"，先回去等通知吧"</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> method.invoke(xxr, args);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">    赚钱 xxr = <span class="keyword">new</span> 小鲜肉();</span><br><span class="line">    合作标准 standard = <span class="keyword">new</span> 合作标准(xxr);</span><br><span class="line">    <span class="comment">//生成类（字节码）：class $Proxy0 extends Proxy implements 赚钱</span></span><br><span class="line">    <span class="comment">//然后反射创建其实例bd，即来一场临时的商务拓展</span></span><br><span class="line">    赚钱 bd = (赚钱) Proxy.newProxyInstance(赚钱<span class="class">.<span class="keyword">class</span>.<span class="title">getClassLoader</span>(),</span></span><br><span class="line">                                        new Class[]&#123;赚钱.class&#125;, </span><br><span class="line">                                        standard);</span><br><span class="line">    <span class="comment">//调用makeMoney，内部转发给了合作标准的invoke</span></span><br><span class="line">    bd.makeMoney(<span class="number">100_0000</span>);</span><br><span class="line">    bd.makeMoney(<span class="number">1000_0000</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>通过栗子可以看出，<code>动态代理</code>不需要提前创建具体的代理类（如<code>经纪人</code>或<code>经纪公司</code>）去实现<code>赚钱</code>接口，而是先拟一份<code>合作标准</code>（InvocationHandler），等到运行期才创建代理类<code>$Proxy0</code>（字节码），然后反射创建其实例<code>商务拓展</code>，这样显得更为灵活。</p>
<p>了解完<code>动态代理</code>，就可以开始Retrofit之旅了~</p>
<h2 id="树干"><a href="#树干" class="headerlink" title="树干"></a>树干</h2><h3 id="简单使用"><a href="#简单使用" class="headerlink" title="简单使用"></a>简单使用</h3><p>引入依赖，</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">implementation <span class="string">'com.squareup.okhttp3:okhttp:3.14.9'</span></span><br><span class="line">implementation <span class="string">'com.squareup.retrofit2:retrofit:2.9.0'</span></span><br><span class="line">implementation <span class="string">'com.squareup.retrofit2:converter-gson:2.9.0'</span></span><br><span class="line">implementation <span class="string">'com.google.code.gson:gson:2.8.6'</span></span><br></pre></td></tr></table></figure>

<p>定义接口<code>WanApi</code>，</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">WanApi</span> </span>&#123;</span><br><span class="line">    <span class="comment">//用注解标记网络请求类型get，参数path</span></span><br><span class="line">    <span class="meta">@GET</span>(<span class="string">"article/list/&#123;page&#125;/json"</span>)</span><br><span class="line">    <span class="function">Call&lt;WanArticleBean&gt; <span class="title">articleList</span><span class="params">(@Path(<span class="string">"page"</span>)</span> <span class="keyword">int</span> page)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>发起请求，</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">RetrofitActivity</span> <span class="keyword">extends</span> <span class="title">AppCompatActivity</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> String SERVER = <span class="string">"https://www.xxx.com/"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</span><br><span class="line">        Retrofit retrofit = <span class="keyword">new</span> Retrofit.Builder()</span><br><span class="line">            .baseUrl(SERVER) <span class="comment">//指定服务器地址</span></span><br><span class="line">            .addConverterFactory(GsonConverterFactory.create()) <span class="comment">//用gson将数据反序列化成实体</span></span><br><span class="line">            .build();</span><br><span class="line">        <span class="comment">//运行期生成一个实现WanApi接口的类（字节码），并反射创建其实例</span></span><br><span class="line">        WanApi wanApi = retrofit.create(WanApi<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">        <span class="comment">//得到Retrofit的call，他封装了okhttp的call</span></span><br><span class="line">        Call&lt;WanArticleBean&gt; call = wanApi.articleList(<span class="number">0</span>);</span><br><span class="line">        <span class="comment">//请求入队</span></span><br><span class="line">        call.enqueue(<span class="keyword">new</span> Callback&lt;WanArticleBean&gt;() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onResponse</span><span class="params">(Call&lt;WanArticleBean&gt; call, Response&lt;WanArticleBean&gt; response)</span> </span>&#123;</span><br><span class="line">                <span class="comment">//得到数据实体</span></span><br><span class="line">                WanArticleBean bean = response.body();</span><br><span class="line">                <span class="comment">//不同于okhttp，Retrofit已经用Handler帮我们切回主线程了</span></span><br><span class="line">                mBinding.tvResult.setText(<span class="string">""</span> + bean.getData().getDatas().size());</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onFailure</span><span class="params">(Call&lt;WanArticleBean&gt; call, Throwable t)</span> </span>&#123;&#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="实现原理"><a href="#实现原理" class="headerlink" title="实现原理"></a>实现原理</h3><p><img src="https://tva1.sinaimg.cn/large/007S8ZIlly1ghvcvkfh1oj31740lodko.jpg" alt=""></p>
<p>由于Retrofit底层基于okhttp，哈迪在<a href="https://juejin.im/post/6856966817844625415" target="_blank" rel="noopener">《看完不忘系列》之okhttp</a>已经对网络流程做了分析，所以本文忽略网络实现只关注Retrofit自身的一些处理，Retrofit对象的构建就是简单的builder模式，我们直接看create，</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//Retrofit.java</span></span><br><span class="line"><span class="keyword">public</span> &lt;T&gt; <span class="function">T <span class="title">create</span><span class="params">(<span class="keyword">final</span> Class&lt;T&gt; service)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//验证</span></span><br><span class="line">    validateServiceInterface(service);</span><br><span class="line">    <span class="keyword">return</span> (T)</span><br><span class="line">        <span class="comment">//动态代理</span></span><br><span class="line">        Proxy.newProxyInstance(</span><br><span class="line">        service.getClassLoader(), <span class="comment">//类加载器</span></span><br><span class="line">        <span class="keyword">new</span> Class&lt;?&gt;[] &#123;service&#125;, <span class="comment">//一组接口</span></span><br><span class="line">        <span class="keyword">new</span> InvocationHandler() &#123;</span><br><span class="line">            <span class="comment">//判断android和jvm平台及其版本</span></span><br><span class="line">            <span class="keyword">private</span> <span class="keyword">final</span> Platform platform = Platform.get();</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> Object <span class="title">invoke</span><span class="params">(Object proxy, Method method, Object[] args)</span></span>&#123;</span><br><span class="line">                <span class="comment">//如果该方法是Object的方法，直接执行不用管</span></span><br><span class="line">                <span class="keyword">if</span> (method.getDeclaringClass() == Object<span class="class">.<span class="keyword">class</span>) </span>&#123;</span><br><span class="line">                    <span class="keyword">return</span> method.invoke(<span class="keyword">this</span>, args);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">//isDefaultMethod：检查是否是java8开始支持的接口默认方法</span></span><br><span class="line">                <span class="keyword">return</span> platform.isDefaultMethod(method)</span><br><span class="line">                    ? platform.invokeDefaultMethod(method, service, proxy, args)</span><br><span class="line">                    : loadServiceMethod(method).invoke(args); <span class="comment">//我们关注这里</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Proxy.newProxyInstance动态代理，运行期会生成一个类（字节码）如<code>$ProxyN</code>，实现传入的接口即<code>WanApi</code>，重写接口方法然后转发给InvocationHandler的invoke，如下（伪代码），</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> $<span class="title">ProxyN</span> <span class="keyword">extends</span> <span class="title">Proxy</span> <span class="keyword">implements</span> <span class="title">WanApi</span></span>&#123;</span><br><span class="line">    <span class="function">Call&lt;WanArticleBean&gt; <span class="title">articleList</span><span class="params">(@Path(<span class="string">"page"</span>)</span> <span class="keyword">int</span> page)</span>&#123;</span><br><span class="line">        <span class="comment">//转发给invocationHandler</span></span><br><span class="line">        invocationHandler.invoke(<span class="keyword">this</span>,method,args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我们先看validateServiceInterface验证逻辑，</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//Retrofit.java</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">validateServiceInterface</span><span class="params">(Class&lt;?&gt; service)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//检查：WanApi不是接口就抛异常...</span></span><br><span class="line">    <span class="comment">//检查：WanApi不能有泛型参数，不能实现其他接口...</span></span><br><span class="line">    <span class="keyword">if</span> (validateEagerly) &#123; <span class="comment">//是否进行严格检查，默认关闭</span></span><br><span class="line">        Platform platform = Platform.get();</span><br><span class="line">        <span class="keyword">for</span> (Method method : service.getDeclaredMethods()) &#123; <span class="comment">//遍历WanApi方法</span></span><br><span class="line">            <span class="comment">//不是默认方法，并且不是静态方法</span></span><br><span class="line">            <span class="keyword">if</span> (!platform.isDefaultMethod(method) &amp;&amp; !Modifier.isStatic(method.getModifiers())) &#123;</span><br><span class="line">                <span class="comment">//把方法提前加载进来（检查下有没有问题）</span></span><br><span class="line">                loadServiceMethod(method);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如果开了validateEagerly，会一次性把接口<code>WanApi</code>的所有方法都检查一遍并加载进来，可以在debug模式下开启，提前发现错误写法，比如在@GET请求设置了@Body这种错误就会抛出异常：</p>
<blockquote>
<p>java.lang.IllegalArgumentException: Non-body HTTP method cannot contain @Body.</p>
</blockquote>
<h4 id="loadServiceMethod"><a href="#loadServiceMethod" class="headerlink" title="loadServiceMethod"></a>loadServiceMethod</h4><p>然后是<code>loadServiceMethod(method).invoke(args)</code>，看名字可知是先找方法，然后执行，</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//Retrofit.java</span></span><br><span class="line"><span class="comment">//缓存，用了线程安全ConcurrentHashMap</span></span><br><span class="line"><span class="keyword">final</span> Map&lt;Method, ServiceMethod&lt;?&gt;&gt; serviceMethodCache = <span class="keyword">new</span> ConcurrentHashMap&lt;&gt;();</span><br><span class="line"></span><br><span class="line">ServiceMethod&lt;?&gt; loadServiceMethod(Method method) &#123;</span><br><span class="line">    ServiceMethod&lt;?&gt; result = serviceMethodCache.get(method);</span><br><span class="line">    <span class="comment">//WanApi的articleList方法已缓存，直接返回</span></span><br><span class="line">    <span class="keyword">if</span> (result != <span class="keyword">null</span>) <span class="keyword">return</span> result;</span><br><span class="line">    <span class="keyword">synchronized</span> (serviceMethodCache) &#123;</span><br><span class="line">        result = serviceMethodCache.get(method);</span><br><span class="line">        <span class="keyword">if</span> (result == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">//解析articleList的注解，创建ServiceMethod并缓存起来</span></span><br><span class="line">            result = ServiceMethod.parseAnnotations(<span class="keyword">this</span>, method);</span><br><span class="line">            serviceMethodCache.put(method, result);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>跟进ServiceMethod.parseAnnotations，</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//ServiceMethod.java</span></span><br><span class="line"><span class="keyword">static</span> &lt;T&gt; <span class="function">ServiceMethod&lt;T&gt; <span class="title">parseAnnotations</span><span class="params">(Retrofit retrofit, Method method)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//1.</span></span><br><span class="line">    RequestFactory requestFactory = RequestFactory.parseAnnotations(retrofit, method);</span><br><span class="line">    <span class="comment">//检查：articleList方法返回类型不能用通配符和void...</span></span><br><span class="line">    <span class="comment">//2.</span></span><br><span class="line">    <span class="keyword">return</span> HttpServiceMethod.parseAnnotations(retrofit, method, requestFactory);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>先看1. RequestFactory.parseAnnotations，</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//RequestFactory.java</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> RequestFactory <span class="title">parseAnnotations</span><span class="params">(Retrofit retrofit, Method method)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> Builder(retrofit, method).build();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Builder</span> </span>&#123;</span><br><span class="line">    <span class="function">RequestFactory <span class="title">build</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">//解析方法注解如GET</span></span><br><span class="line">        <span class="keyword">for</span> (Annotation annotation : methodAnnotations) &#123;</span><br><span class="line">            parseMethodAnnotation(annotation);</span><br><span class="line">        &#125;</span><br><span class="line">		<span class="comment">//省略各种检查...</span></span><br><span class="line">        <span class="comment">//解析参数注解如Path</span></span><br><span class="line">        <span class="keyword">int</span> parameterCount = parameterAnnotationsArray.length;</span><br><span class="line">        parameterHandlers = <span class="keyword">new</span> ParameterHandler&lt;?&gt;[parameterCount];</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> p = <span class="number">0</span>, lastParameter = parameterCount - <span class="number">1</span>; p &lt; parameterCount; p++) &#123;</span><br><span class="line">            parameterHandlers[p] =</span><br><span class="line">                parseParameter(p, parameterTypes[p], parameterAnnotationsArray[p], p == lastParameter);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//省略各种检查...</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> RequestFactory(<span class="keyword">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>得到RequestFactory后，看2. HttpServiceMethod.parseAnnotations，HttpServiceMethod负责适配和转换处理，将接口方法的调用调整为HTTP调用，</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//HttpServiceMethod.java</span></span><br><span class="line"><span class="comment">//ResponseT响应类型如WanArticleBean，ReturnT返回类型如Call</span></span><br><span class="line"><span class="keyword">static</span> &lt;ResponseT, ReturnT&gt; <span class="function">HttpServiceMethod&lt;ResponseT, ReturnT&gt; <span class="title">parseAnnotations</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">    Retrofit retrofit, Method method, RequestFactory requestFactory)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//省略kotlin协程逻辑...</span></span><br><span class="line">    Annotation[] annotations = method.getAnnotations();</span><br><span class="line">    <span class="comment">//遍历找到合适的适配器</span></span><br><span class="line">    CallAdapter&lt;ResponseT, ReturnT&gt; callAdapter =</span><br><span class="line">        createCallAdapter(retrofit, method, adapterType, annotations);</span><br><span class="line">    <span class="comment">//得到响应类型，如WanArticleBean</span></span><br><span class="line">    Type responseType = callAdapter.responseType();</span><br><span class="line">    <span class="comment">//遍历找到合适的转换器</span></span><br><span class="line">    Converter&lt;ResponseBody, ResponseT&gt; responseConverter =</span><br><span class="line">        createResponseConverter(retrofit, method, responseType);</span><br><span class="line">    okhttp3.Call.Factory callFactory = retrofit.callFactory;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> CallAdapted&lt;&gt;(requestFactory, callFactory, responseConverter, callAdapter);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可见最终返回了一个CallAdapted，看到CallAdapted，</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//CallAdapted extends HttpServiceMethod extends ServiceMethod</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CallAdapted</span>&lt;<span class="title">ResponseT</span>, <span class="title">ReturnT</span>&gt; <span class="keyword">extends</span> <span class="title">HttpServiceMethod</span>&lt;<span class="title">ResponseT</span>, <span class="title">ReturnT</span>&gt; </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> CallAdapter&lt;ResponseT, ReturnT&gt; callAdapter;</span><br><span class="line"></span><br><span class="line">    CallAdapted(</span><br><span class="line">        RequestFactory requestFactory,</span><br><span class="line">        okhttp3.Call.Factory callFactory,</span><br><span class="line">        Converter&lt;ResponseBody, ResponseT&gt; responseConverter,</span><br><span class="line">        CallAdapter&lt;ResponseT, ReturnT&gt; callAdapter) &#123;</span><br><span class="line">        <span class="keyword">super</span>(requestFactory, callFactory, responseConverter);</span><br><span class="line">        <span class="keyword">this</span>.callAdapter = callAdapter;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> ReturnT <span class="title">adapt</span><span class="params">(Call&lt;ResponseT&gt; call, Object[] args)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//适配器</span></span><br><span class="line">        <span class="keyword">return</span> callAdapter.adapt(call);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>那这个CallAdapter实例到底是谁呢，我们先回到Retrofit.Builder，</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//Retrofit.Builder.java</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Retrofit <span class="title">build</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    Executor callbackExecutor = <span class="keyword">this</span>.callbackExecutor;</span><br><span class="line">    <span class="comment">//如果没设置线程池，则给android平台设置一个默认的MainThreadExecutor（用Handler将回调切回主线程）</span></span><br><span class="line">    <span class="keyword">if</span> (callbackExecutor == <span class="keyword">null</span>) &#123;</span><br><span class="line">        callbackExecutor = platform.defaultCallbackExecutor();</span><br><span class="line">    &#125;</span><br><span class="line">    List&lt;CallAdapter.Factory&gt; callAdapterFactories = <span class="keyword">new</span> ArrayList&lt;&gt;(<span class="keyword">this</span>.callAdapterFactories);</span><br><span class="line">    <span class="comment">//添加默认的DefaultCallAdapterFactory</span></span><br><span class="line">    callAdapterFactories.addAll(platform.defaultCallAdapterFactories(callbackExecutor));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>DefaultCallAdapterFactory这个工厂创建具体的CallAdapter实例，</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//DefaultCallAdapterFactory.java</span></span><br><span class="line"><span class="keyword">public</span> CallAdapter&lt;?, ?&gt; get(Type returnType, Annotation[] annotations, Retrofit retrofit) &#123;</span><br><span class="line">    <span class="keyword">final</span> Type responseType = Utils.getParameterUpperBound(<span class="number">0</span>, (ParameterizedType) returnType);</span><br><span class="line">    <span class="comment">//如果指定了SkipCallbackExecutor注解，就表示不需要切回主线程</span></span><br><span class="line">    <span class="keyword">final</span> Executor executor =</span><br><span class="line">        Utils.isAnnotationPresent(annotations, SkipCallbackExecutor<span class="class">.<span class="keyword">class</span>)</span></span><br><span class="line"><span class="class">        ? <span class="title">null</span></span></span><br><span class="line">        : callbackExecutor;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> CallAdapter&lt;Object, Call&lt;?&gt;&gt;() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> Type <span class="title">responseType</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> responseType;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> Call&lt;Object&gt; <span class="title">adapt</span><span class="params">(Call&lt;Object&gt; call)</span> </span>&#123;</span><br><span class="line">            <span class="comment">//默认情况下，返回用主线程池包装的Call，他的enqueue会使用主线程池的execute</span></span><br><span class="line">            <span class="keyword">return</span> executor == <span class="keyword">null</span> ? call : <span class="keyword">new</span> ExecutorCallbackCall&lt;&gt;(executor, call);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="invoke"><a href="#invoke" class="headerlink" title="invoke"></a>invoke</h4><p>前边<code>loadServiceMethod</code>得到了CallAdapted，然后执行invoke，实现在父类HttpServiceMethod里，</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//HttpServiceMethod.java</span></span><br><span class="line"><span class="function"><span class="keyword">final</span> ReturnT <span class="title">invoke</span><span class="params">(Object[] args)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//终于见到okhttp了！</span></span><br><span class="line">    Call&lt;ResponseT&gt; call = <span class="keyword">new</span> OkHttpCall&lt;&gt;(requestFactory, args, callFactory, responseConverter);</span><br><span class="line">    <span class="keyword">return</span> adapt(call, args);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CallAdapted</span>&lt;<span class="title">ResponseT</span>, <span class="title">ReturnT</span>&gt; <span class="keyword">extends</span> <span class="title">HttpServiceMethod</span>&lt;<span class="title">ResponseT</span>, <span class="title">ReturnT</span>&gt; </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> CallAdapter&lt;ResponseT, ReturnT&gt; callAdapter;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> ReturnT <span class="title">adapt</span><span class="params">(Call&lt;ResponseT&gt; call, Object[] args)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//用前边得到的适配器，把OkHttpCall包成ExecutorCallbackCall</span></span><br><span class="line">        <span class="keyword">return</span> callAdapter.adapt(call);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后是请求入队，ExecutorCallbackCall.enqueue -&gt; OkHttpCall.enqueue，</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//ExecutorCallbackCall.java</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">enqueue</span><span class="params">(<span class="keyword">final</span> Callback&lt;T&gt; callback)</span> </span>&#123;</span><br><span class="line">    delegate.enqueue(</span><br><span class="line">        <span class="keyword">new</span> Callback&lt;T&gt;() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onResponse</span><span class="params">(Call&lt;T&gt; call, <span class="keyword">final</span> Response&lt;T&gt; response)</span> </span>&#123;</span><br><span class="line">                <span class="comment">//将回调切回主线程</span></span><br><span class="line">                callbackExecutor.execute(</span><br><span class="line">                    () -&gt; &#123;</span><br><span class="line">                        callback.onResponse(ExecutorCallbackCall.<span class="keyword">this</span>, response);</span><br><span class="line">                    &#125;);</span><br><span class="line">                <span class="comment">//...</span></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onFailure</span><span class="params">(Call&lt;T&gt; call, <span class="keyword">final</span> Throwable t)</span> </span>&#123;&#125;</span><br><span class="line">        &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//OkHttpCall.java</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">enqueue</span><span class="params">(<span class="keyword">final</span> Callback&lt;T&gt; callback)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//okhttp逻辑</span></span><br><span class="line">    okhttp3.Call call;</span><br><span class="line">    call.enqueue(<span class="keyword">new</span> okhttp3.Callback() &#123;</span><br><span class="line">        <span class="function"><span class="keyword">void</span> <span class="title">onResponse</span><span class="params">(okhttp3.Call call, okhttp3.Response rawResponse)</span> </span>&#123;</span><br><span class="line">            callback.onResponse(OkHttpCall.<span class="keyword">this</span>, response);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>总算把流程跑通了，回到前边再看一遍流程图，就豁然开朗了~</p>
<h2 id="细枝"><a href="#细枝" class="headerlink" title="细枝"></a>细枝</h2><h3 id="CallAdapter"><a href="#CallAdapter" class="headerlink" title="CallAdapter"></a>CallAdapter</h3><p>CallAdapter适配器用于适配返回类型，比如还可以支持Rxjava、协程的使用，</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">WanApi</span> </span>&#123;</span><br><span class="line">    <span class="comment">//Call</span></span><br><span class="line">    <span class="meta">@GET</span>(<span class="string">"article/list/&#123;page&#125;/json"</span>)</span><br><span class="line">    <span class="function">Call&lt;WanArticleBean&gt; <span class="title">articleList</span><span class="params">(@Path(<span class="string">"page"</span>)</span> <span class="keyword">int</span> page)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//Rxjava，需要 addCallAdapterFactory(RxJavaCallAdapterFactory.create())</span></span><br><span class="line">    <span class="meta">@GET</span>(<span class="string">"article/list/&#123;page&#125;/json"</span>)</span><br><span class="line">    <span class="function">Observable&lt;WanArticleBean&gt; <span class="title">articleListRx</span><span class="params">(@Path(<span class="string">"page"</span>)</span> <span class="keyword">int</span> page)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Converter"><a href="#Converter" class="headerlink" title="Converter"></a>Converter</h3><p>Converter转换器用于转换参数类型，比如把Long时间戳格式化成string再传给后端，</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">WanApi</span> </span>&#123;</span><br><span class="line">    <span class="comment">//Long cur 当前时间</span></span><br><span class="line">    <span class="meta">@GET</span>(<span class="string">"article/list/&#123;page&#125;/json"</span>)</span><br><span class="line">    <span class="function">Call&lt;WanArticleBean&gt; <span class="title">articleList</span><span class="params">(@Path(<span class="string">"page"</span>)</span> <span class="keyword">int</span> page, @<span class="title">Query</span><span class="params">(<span class="string">"cur"</span>)</span> Long cur)</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TimeConverter</span> <span class="keyword">implements</span> <span class="title">Converter</span>&lt;<span class="title">Long</span>, <span class="title">String</span>&gt; </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> SimpleDateFormat mFormat = <span class="keyword">new</span> SimpleDateFormat(<span class="string">"yyyy-MM-dd-HHmmss"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">convert</span><span class="params">(Long value)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (value &gt; <span class="number">1_000_000_000_000L</span>) &#123;<span class="comment">//毫秒，不是很严谨 - -</span></span><br><span class="line">            <span class="keyword">return</span> mFormat.format(<span class="keyword">new</span> Date(value));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> String.valueOf(value);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TimeConverterFactory</span> <span class="keyword">extends</span> <span class="title">Converter</span>.<span class="title">Factory</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Converter&lt;?, String&gt; stringConverter(Type type, Annotation[] annotations, Retrofit retrofit) &#123;</span><br><span class="line">        <span class="keyword">if</span> (type == Long<span class="class">.<span class="keyword">class</span>) </span>&#123;</span><br><span class="line">            <span class="comment">//使用自定义TimeConverter</span></span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> TimeConverter();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">super</span>.stringConverter(type, annotations, retrofit);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Converter.<span class="function">Factory <span class="title">create</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> TimeConverterFactory();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//再设置一下就行了，addConverterFactory(TimeConverterFactory.create())</span></span><br></pre></td></tr></table></figure>

<h3 id="动态替换url"><a href="#动态替换url" class="headerlink" title="动态替换url"></a>动态替换url</h3><p>在构建Retrofit时传入HttpUrl对象，之后这个实例就一直存在不会更改，所以可以反射修改他的字段比如host，来实现动态替换服务端地址，</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">String SERVER = <span class="string">"https://www.xxx.com/"</span>;</span><br><span class="line">HttpUrl httpUrl = HttpUrl.get(SERVER);</span><br><span class="line">Retrofit retrofit = <span class="keyword">new</span> Retrofit.Builder()</span><br><span class="line">    <span class="comment">//.baseUrl(SERVER)</span></span><br><span class="line">    .baseUrl(httpUrl) <span class="comment">//使用HttpUrl</span></span><br><span class="line">    .build();</span><br></pre></td></tr></table></figure>

<h2 id="尾声"><a href="#尾声" class="headerlink" title="尾声"></a>尾声</h2><p>咱们下期见~😆</p>
<p>系列文章：</p>
<ul>
<li><a href="https://juejin.im/post/6856966817844625415" target="_blank" rel="noopener">《看完不忘系列》之okhttp</a></li>
<li><a href="https://juejin.im/post/6850037281349173261" target="_blank" rel="noopener">《看完不忘系列》之Glide</a></li>
</ul>
<h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><ul>
<li><a href="https://github.com/square/retrofit">GitHub</a> &amp; <a href="https://square.github.io/retrofit/" target="_blank" rel="noopener">文档</a> &amp; <a href="https://square.github.io/retrofit/2.x/retrofit/" target="_blank" rel="noopener">API</a></li>
<li><a href="https://www.imooc.com/view/1128" target="_blank" rel="noopener">imooc - 破解Retrofit</a></li>
<li><a href="https://www.jianshu.com/p/f57b7cdb1c99" target="_blank" rel="noopener">简书 - 从架构角度看Retrofit的作用、原理和启示</a></li>
<li><a href="https://www.jianshu.com/p/9bcac608c714" target="_blank" rel="noopener">简书 - JAVA动态代理</a></li>
<li><a href="https://blog.csdn.net/danchu/article/details/70238002" target="_blank" rel="noopener">csdn - CGLIB(Code Generation Library)详解</a></li>
<li><a href="https://www.zhihu.com/question/20794107" target="_blank" rel="noopener">知乎 - Java 动态代理作用是什么？</a></li>
</ul>
<hr>
<p><a href="https://tva1.sinaimg.cn/large/007S8ZIlly1gg3mnwsbshj308c0augmm.jpg" target="_blank" rel="noopener">欢迎关注原创技术公众号：哈利迪ei</a></p>
<p><img src="https://tva1.sinaimg.cn/large/007S8ZIlly1gg3mnwsbshj308c0augmm.jpg" alt=""></p>

      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/Android/" rel="tag"># Android</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2020/08/12/Android-okhttp%E7%BB%86%E6%9E%9D%E7%AF%87/" rel="next" title="Android | okhttp细枝篇">
                <i class="fa fa-chevron-left"></i> Android | okhttp细枝篇
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2020/08/27/Android-%E3%80%8A%E7%9C%8B%E5%AE%8C%E4%B8%8D%E5%BF%98%E7%B3%BB%E5%88%97%E3%80%8B%E4%B9%8Bdagger/" rel="prev" title="Android |《看完不忘系列》之dagger">
                Android |《看完不忘系列》之dagger <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">哈利迪</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">


              <div class="site-state-item site-state-posts">
                <a href="/archives">
                  <span class="site-state-item-count">36</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>



            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">3</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          

          

          
          

          
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#预备"><span class="nav-number">1.</span> <span class="nav-text">预备</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#静态代理"><span class="nav-number">1.1.</span> <span class="nav-text">静态代理</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#动态代理"><span class="nav-number">1.2.</span> <span class="nav-text">动态代理</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#树干"><span class="nav-number">2.</span> <span class="nav-text">树干</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#简单使用"><span class="nav-number">2.1.</span> <span class="nav-text">简单使用</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#实现原理"><span class="nav-number">2.2.</span> <span class="nav-text">实现原理</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#loadServiceMethod"><span class="nav-number">2.2.1.</span> <span class="nav-text">loadServiceMethod</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#invoke"><span class="nav-number">2.2.2.</span> <span class="nav-text">invoke</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#细枝"><span class="nav-number">3.</span> <span class="nav-text">细枝</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#CallAdapter"><span class="nav-number">3.1.</span> <span class="nav-text">CallAdapter</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Converter"><span class="nav-number">3.2.</span> <span class="nav-text">Converter</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#动态替换url"><span class="nav-number">3.3.</span> <span class="nav-text">动态替换url</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#尾声"><span class="nav-number">4.</span> <span class="nav-text">尾声</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#参考资料"><span class="nav-number">5.</span> <span class="nav-text">参考资料</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">哈利迪</span>

  
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Pisces</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.4"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  





  

  

  

  
  

  

  

  

</body>
</html>
